# 分布式文件存储系统

这是一个基于Java实现的分布式文件存储系统，采用Controller-Dstore架构，支持文件的存储、加载、删除等基本操作，并具有自动负载均衡功能。

## 系统架构

系统由以下三个主要组件组成：

1. **Controller（控制器）**
    - 作为系统的中央协调器
    - 管理所有Dstore节点
    - 处理客户端请求
    - 实现一致性哈希算法进行数据分布
    - 执行定期的负载均衡

2. **Dstore（数据存储节点）**
    - 负责实际的文件存储
    - 支持文件的存储、加载和删除
    - 与Controller保持心跳连接
    - 参与系统的负载均衡过程

3. **Client（客户端）**
    - 提供文件操作接口
    - 与Controller通信进行文件操作
    - 支持并发操作

## 主要功能

1. **文件操作**
    - 存储文件（STORE）
    - 加载文件（LOAD）
    - 删除文件（REMOVE）
    - 列出所有文件（LIST）

2. **自动负载均衡**
    - 定期执行负载均衡
    - 在节点加入/退出时重新分配数据
    - 使用一致性哈希算法确保数据分布均匀

3. **容错机制**
    - 文件多副本存储
    - 节点失效检测
    - 自动数据恢复

## 系统配置

系统启动需要以下参数：

### Controller配置
- cPort：Controller监听端口
- r：文件副本数
- timeout：超时时间（毫秒）
- rebalancePeriod：负载均衡周期（毫秒）

### Dstore配置
- dPort：Dstore监听端口
- cPort：Controller端口
- timeout：超时时间（毫秒）
- fileFolder：文件存储目录

## 通信协议

系统使用自定义的文本协议进行通信，主要包括：

### 客户端命令
- LIST：列出所有文件
- STORE：存储文件
- LOAD：加载文件
- REMOVE：删除文件

### Controller命令
- STORE_TO：指定存储位置
- STORE_COMPLETE：存储完成
- LOAD_FROM：指定加载位置
- REMOVE_COMPLETE：删除完成
- REBALANCE：触发负载均衡

### Dstore命令
- ACK：确认消息
- STORE_ACK：存储确认
- REMOVE_ACK：删除确认
- JOIN：加入系统
- REBALANCE_STORE：负载均衡存储
- REBALANCE_COMPLETE：负载均衡完成

## 一致性哈希算法详解

本系统使用改进的一致性哈希算法来实现数据的分布式存储。这种算法不仅确保了数据的均匀分布，还支持存储节点的动态添加和删除。

### 算法核心概念

1. **虚拟节点**
    - 系统使用虚拟节点（Virtual Dstore）来增强数据分布的均匀性
    - 每个实际的存储节点（Dstore）对应多个虚拟节点
    - 虚拟节点数量可通过配置文件调整（Config.virtualDstoreCount）

2. **哈希环构造**
    - 使用整数范围（0 到 Integer.MAX_VALUE）构建哈希环
    - 虚拟节点均匀分布在哈希环上
    - 每个虚拟节点负责管理其哈希值到下一个节点之间的数据

3. **数据分布策略**
    - 使用MD5算法计算文件名的哈希值
    - 在哈希环上顺时针查找最近的虚拟节点
    - 支持数据多副本存储（参数r控制副本数）

### 负载均衡机制

1. **动态节点管理**
    - 新节点加入时自动重新分配虚拟节点
    - 节点退出时将其负责的虚拟节点重新分配
    - 通过虚拟节点的重新分配最小化数据迁移

2. **数据迁移策略**
    - 增量式数据迁移，只迁移必要的数据
    - 迁移过程中保证系统可用性
    - 自动处理迁移失败的情况

3. **冲突处理**
    - 使用再哈希机制处理节点冲突
    - 当选择存储节点时遇到重复，会对哈希值进行重新计算
    - 最多重试10次以保证找到合适的存储节点

### 优势特点

1. **高扩展性**
    - 支持存储节点的动态添加和删除
    - 通过虚拟节点机制提高负载均衡效果
    - 最小化节点变更带来的系统影响

2. **数据均衡**
    - 虚拟节点的引入显著提高了数据分布的均匀性
    - 自动调整虚拟节点分配以优化数据分布
    - 支持自定义副本数量以平衡可用性和存储开销

3. **容错能力**
    - 多副本机制保证数据可用性
    - 节点失效时自动进行数据恢复
    - 支持数据的一致性检查和修复

## 项目结构

- `Controller.java`: 控制器实现
- `Dstore.java`: 存储节点实现
- `ClientMain.java`: 客户端实现
- `Protocol.java`: 通信协议定义
- `ConsistentHash.java`: 一致性哈希算法实现
- `FileUtils.java`: 文件操作工具类
- `Communication.java`: 网络通信工具类

## 使用说明

1. 启动Controller：
```bash
java Controller <cPort> <r> <timeout> <rebalancePeriod>
```

2. 启动Dstore节点：
```bash
java Dstore <dPort> <cPort> <timeout> <fileFolder>
```

3. 使用客户端：
```bash
java ClientMain
```

## 特点和优势

1. **高可用性**
    - 多副本存储确保数据可用性
    - 自动故障检测和恢复

2. **可扩展性**
    - 支持动态添加/删除存储节点
    - 自动负载均衡确保系统性能

3. **一致性保证**
    - 使用一致性哈希算法
    - 确保数据分布均匀

4. **容错性**
    - 节点失效自动处理
    - 数据自动恢复机制

## 开发环境

- Java 8+
- 无外部依赖
